---
import BaseLayout from "../../components/BaseLayout.astro";
import SmartBackButton from "../../components/ui/SmartBackButton.astro";
import { container } from "../../core/di/container";

// Extend Window interface for Microsoft Clarity
declare global {
  interface Window {
    clarity?: (action: string, ...args: any[]) => void;
  }
}

export async function getStaticPaths() {
  try {
    const blogService = container.getBlogService();
    const posts = await blogService.getAllPosts();
    console.log("[getStaticPaths] Total posts loaded:", posts?.length || 0); // Return empty array if no posts to prevent build errors
    if (!posts || posts.length === 0) {
      console.warn("[getStaticPaths] No posts found");
      return [];
    } // Filter out invalid posts and ensure all required properties exist
    const validPosts = posts.filter((post) => {
      const isValid = post && post.slug && post.title && post.publishedAt;
      if (!isValid) {
        console.warn("[getStaticPaths] Invalid post filtered out:", {
          slug: post?.slug,
          hasTitle: !!post?.title,
          hasPublishedAt: !!post?.publishedAt,
        });
      }
      return isValid;
    });
    console.log("[getStaticPaths] Valid posts:", validPosts.length);
    console.log(
      "[getStaticPaths] Post slugs:",
      validPosts.map((p) => p.slug),
    );
    return validPosts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error("Error in getStaticPaths for blog:", error);
    return [];
  }
}
let { post } = Astro.props;
const { slug } = Astro.params; // If post is not in static paths (server mode fallback), try to
// fetch it
if (!post && slug) {
  try {
    const blogService = container.getBlogService();
    post = (await blogService.getPostBySlug(slug)) || null;
  } catch (error) {
    console.error("Error fetching post by slug:", error);
  }
} //
// Safety check: if post is still undefined, return 404
if (!post) {
  return new Response(null, { status: 404, statusText: "Not Found" });
} // Ensure
// publishedAt is a Date object
if (post.publishedAt && !(post.publishedAt instanceof Date)) {
  post.publishedAt = new Date(post.publishedAt);
} // Get full
// content from JSON
let fullContent = "";
try {
  const blogData = await import("../../data/external/blogger.json");
  const rawPosts = blogData.default || [];
  const rawPost = rawPosts.find((p: any) => p.slug === post.slug);
  fullContent = rawPost?.content || "";
} catch (e) {
  // Content not available
  console.error("Error loading blog content:", e);
}
/** * Calculate reading time
from content * @param content - HTML content string * @returns Reading time in
minutes (minimum 1) */ function getReadingTime(content: string): number {
  if (!content) return 1; // Strip HTML tags
  const textContent = content.replace(/<[^>]*>/g, ""); // Count words (split by whitespace and filter empty strings)
  const wordCount = textContent
    .split(/\s+/)
    .filter((word) => word.length > 0).length; // Calculate reading time (200 words per minute) and round up
  const readingTime = Math.ceil(wordCount / 200); // Ensure minimum of 1 minute
  return readingTime < 1 ? 1 : readingTime;
}
const readingTime = getReadingTime(fullContent);
const currentUrl = Astro.url.href;
---

<BaseLayout
  title={`${post.title} | Raj Kawale`}
  description={`An essay on ${post.title},
exploring product decisions, user psychology, and system-level tradeoffs in
technology products.`}
  keywords="product management insights, mental models, AI products, systems thinking, decision making"
>
  <main
    class="min-h-screen bg-[#020617] text-zinc-300 py-24 px-6 md:px-12 relative z-10"
    style="padding-top: 150px;"
  >
    <article class="max-w-4xl mx-auto">
      <header class="mb-12 border-b border-zinc-800 pb-8">
        <h1
          class="mb-6 text-4xl md:text-5xl font-serif font-bold text-slate-100 leading-tight"
        >
          {post.title}
        </h1>
        <!-- Meta Row -->
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <time
            datetime={post.publishedAt.toISOString()}
            class="font-mono text-zinc-400"
          >
            {
              post.publishedAt.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              })
            }
          </time>
          <span class="text-zinc-600">•</span>
          <span class="font-sans text-zinc-400"> {readingTime} min read </span>
          {
            post.category && (
              <>
                {" "}
                <span class="text-zinc-600">•</span>{" "}
                <span class="px-3 py-1 rounded-full text-xs font-mono font-medium bg-white/[0.03] border border-white/10 text-zinc-300">
                  {" "}
                  {post.category}{" "}
                </span>{" "}
              </>
            )
          }
        </div>
      </header>
      <div
        class="prose prose-lg max-w-none prose-headings:font-serif prose-headings:text-slate-100 prose-p:text-zinc-300 prose-a:text-[#888] prose-a:no-underline prose-a:hover:underline"
      >
        {
          fullContent ? (
            <div set:html={fullContent} />
          ) : (
            <p class="text-zinc-400 font-sans">Content loading...</p>
          )
        }
      </div>
      <!-- Connect Footer -->
      <div class="mt-16 mb-12">
        <div
          class="connect-card bg-white/[0.03] backdrop-blur-xl border border-white/10 rounded-lg p-6 md:p-8"
        >
          <div class="flex items-start gap-4 mb-6">
            <div
              class="flex-shrink-0 w-12 h-12 rounded-full bg-white/5 border border-white/10 flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-zinc-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
            </div>
            <div class="flex-1">
              <p class="text-base text-zinc-300 font-sans leading-relaxed">
                I write about building systems and AI. If you found this
                valuable, let's connect.
              </p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3">
            <a
              href="https://www.linkedin.com/in/rajkawale/"
              target="_blank"
              target="_blank"
              rel="noopener noreferrer"
              class="connect-button flex items-center gap-2 px-4 py-2.5 rounded border border-white/20 bg-black/20 backdrop-blur-sm hover:bg-black/30 hover:border-white/30 transition-all text-sm font-mono text-white"
              data-track-share-linkedin
            >
              <svg
                class="w-4 h-4"
                fill="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                ></path>
              </svg> Discuss on LinkedIn
            </a>
            <a
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(currentUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="connect-button flex items-center gap-2 px-4 py-2.5 rounded border border-white/20 bg-black/20 backdrop-blur-sm hover:bg-black/30 hover:border-white/30 transition-all text-sm font-mono text-white"
              data-track-share-twitter
            >
              <svg
                class="w-4 h-4"
                fill="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                ></path>
              </svg>
              Share Article
            </a>
          </div>
        </div>
      </div>

      <footer class="mt-8 border-t border-zinc-800 pt-6">
        <SmartBackButton
          label="Back to writing"
          fallbackHref="/blog"
          className="mb-0"
        />
      </footer>

      <style>
        .prose a {
          color: #888;
          text-decoration: none;
          font-weight: 500;
          transition: all 0.3s ease-out;
        }
        .prose a:hover {
          color: #fff;
          text-decoration: underline;
          text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        /* Pull Quote Styling */
        .prose blockquote,
        .pull-quote {
          font-size: 24px;
          font-style: italic;
          font-family: serif;
          border-left: 3px solid rgba(255, 255, 255, 0.8);
          padding-left: 1.5rem;
          margin: 2rem 0;
          color: #f1f5f9;
          text-shadow: 0 0 12px rgba(255, 255, 255, 0.3);
          background: rgba(255, 255, 255, 0.02);
          padding: 1.5rem;
          border-radius: 0.5rem;
        }

        .prose blockquote p,
        .pull-quote p {
          margin: 0;
          font-size: inherit;
          font-style: inherit;
          font-family: inherit;
        }

        /* Connect Card Styling */
        .connect-card {
          transition: all 0.3s ease-out;
        }

        .connect-card:hover {
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
          border-color: rgba(255, 255, 255, 0.2);
        }

        .connect-button {
          transition: all 0.3s ease-out;
        }

        .connect-button:hover {
          box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
          border-color: rgba(255, 255, 255, 0.4);
          text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }
      </style>

      <script>
        // Back navigation is now handled by the BackNavigation component using browser history

        // Track article reading depth and engagement
        (function () {
          const slug = window.location.pathname.split("/").pop() || "unknown";
          const slugFormatted = slug.replace(/-/g, "_");
          const trackedDepths = {};
          const depthThresholds = [0.25, 0.5, 0.75, 1.0];

          function trackEvent(eventName) {
            if (typeof window !== "undefined" && window.clarity) {
              window.clarity("event", eventName);
            }
          }

          // Track article start
          trackEvent(`Article_Read_Start_${slugFormatted}`);

          function checkScrollProgress() {
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;
            const scrollTop =
              window.pageYOffset || document.documentElement.scrollTop;
            const scrollPercentage =
              (scrollTop + windowHeight) / documentHeight;

            depthThresholds.forEach((threshold) => {
              const percent = Math.round(threshold * 100);
              if (scrollPercentage >= threshold && !trackedDepths[percent]) {
                trackedDepths[percent] = true;
                if (percent === 25) {
                  trackEvent(`Article_Read_25_Percent_${slugFormatted}`);
                } else if (percent === 50) {
                  trackEvent(`Article_Read_50_Percent_${slugFormatted}`);
                } else if (percent === 75) {
                  trackEvent(`Article_Read_75_Percent_${slugFormatted}`);
                  trackEvent("Article_Read_Complete"); // Keep existing event
                } else if (percent === 100) {
                  trackEvent(`Article_Read_100_Percent_${slugFormatted}`);
                }
              }
            });
          }

          // Throttle scroll events
          let ticking = false;
          window.addEventListener(
            "scroll",
            () => {
              if (!ticking) {
                window.requestAnimationFrame(() => {
                  checkScrollProgress();
                  ticking = false;
                });
                ticking = true;
              }
            },
            { passive: true },
          );

          // Track time-based engagement
          const timeThresholds = [30, 60, 120, 300]; // 30s, 1min, 2min, 5min
          timeThresholds.forEach((seconds) => {
            setTimeout(() => {
              const timeLabel =
                seconds === 30
                  ? "30s"
                  : seconds === 60
                    ? "1min"
                    : seconds === 120
                      ? "2min"
                      : "5min";
              trackEvent(`Article_Time_Spent_${timeLabel}_${slugFormatted}`);
            }, seconds * 1000);
          });

          // Track article share buttons
          const linkedInShare = document.querySelector(
            "[data-track-share-linkedin]",
          );
          if (linkedInShare) {
            linkedInShare.addEventListener("click", () => {
              trackEvent(`Article_Share_LinkedIn_${slugFormatted}`);
            });
          }

          const twitterShare = document.querySelector(
            "[data-track-share-twitter]",
          );
          if (twitterShare) {
            twitterShare.addEventListener("click", () => {
              trackEvent(`Article_Share_Twitter_${slugFormatted}`);
            });
          }

          // Track back navigation
          const backNav = document.querySelector("[data-track-back-nav]");
          if (backNav) {
            backNav.addEventListener("click", () => {
              const referrer = document.referrer;
              if (
                referrer &&
                (referrer.includes("/blog") || referrer.includes("/writing"))
              ) {
                trackEvent("Article_Back_To_Blog");
              } else {
                trackEvent("Article_Back_To_Home");
              }
            });
          }
        })();
      </script>
    </article>
  </main>
</BaseLayout>
