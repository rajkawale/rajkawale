---
import BaseLayout from '../../components/BaseLayout.astro';
import { container } from '../../core/di/container';
import ArticleRow from '../../components/ui/ArticleRow.astro';
import BackNavigation from '../../components/ui/BackNavigation.astro';

const blogService = container.getBlogService();
const allPosts = await blogService.getAllPosts();
// Posts are already sorted by date (newest first) from the repository
const latestPost = allPosts[0];
const olderPosts = allPosts.slice(1);

/**
 * Calculate reading time from content
 * @param content - HTML content string
 * @returns Reading time in minutes (minimum 1)
 */
function getReadingTime(content: string): number {
  if (!content) return 1;
  // Strip HTML tags
  const textContent = content.replace(/<[^>]*>/g, '');
  // Count words (split by whitespace and filter empty strings)
  const wordCount = textContent.split(/\s+/).filter(word => word.length > 0).length;
  // Calculate reading time (200 words per minute) and round up
  const readingTime = Math.ceil(wordCount / 200);
  // Ensure minimum of 1 minute
  return readingTime < 1 ? 1 : readingTime;
}

// Get reading time for featured post
let featuredPostReadingTime = 1;
if (latestPost) {
  try {
    const blogData = await import('../../data/external/blogger.json');
    const rawPosts = blogData.default || [];
    const rawPost = rawPosts.find((p: any) => p.slug === latestPost.slug);
    const fullContent = rawPost?.content || '';
    featuredPostReadingTime = getReadingTime(fullContent);
    console.log('[Blog Index] Featured post reading time:', featuredPostReadingTime);
  } catch (e) {
    // Content not available, use default
    console.error('[Blog Index] Error loading blog content for reading time:', e);
  }
  // Ensure publishedAt is a Date object
  if (latestPost.publishedAt && !(latestPost.publishedAt instanceof Date)) {
    latestPost.publishedAt = new Date(latestPost.publishedAt);
  }
}
console.log('[Blog Index] All posts count:', allPosts.length);
console.log('[Blog Index] Latest post:', latestPost?.title);
console.log('[Blog Index] Featured post reading time final:', featuredPostReadingTime);

// Get reading times for archive posts
let olderPostsWithReadTime: Array<{ post: typeof allPosts[0]; readTime: number }> = [];
if (olderPosts.length > 0) {
  try {
    const blogData = await import('../../data/external/blogger.json');
    const rawPosts = blogData.default || [];
    olderPostsWithReadTime = olderPosts.map((post) => {
      const rawPost = rawPosts.find((p: any) => p.slug === post.slug);
      const fullContent = rawPost?.content || '';
      const readTime = getReadingTime(fullContent);
      return { post, readTime };
    });
  } catch (e) {
    // If content not available, use default read time of 1
    console.error('Error loading blog content for reading time:', e);
    olderPostsWithReadTime = olderPosts.map((post) => ({ post, readTime: 1 }));
  }
}
---

<BaseLayout
  title="Think | Writing on Product, AI, and Systems – Raj Kawale"
  description="Writing on product decisions, cognitive AI, business mechanics, and mental models. Notes on building, shipping, and scaling technology products."
  keywords="product thinking, mental models, AI product management, systems thinking, product decisions, scaling technology products"
>
  <main class="min-h-screen bg-[#020617] text-zinc-300 py-24 px-6 md:px-12 relative z-10" style="padding-top: 150px;">
    <div class="max-w-4xl mx-auto">
      <header class="mb-12 border-b border-zinc-800 pb-6">
        <h1 class="text-4xl md:text-5xl font-serif font-bold text-white mb-4">
          Writing
        </h1>
        <p class="text-lg text-zinc-300 font-sans">
          Insights on product management, AI innovation, and building scalable systems.
        </p>
      </header>
      
      {allPosts.length > 0 ? (
        <div>
          <!-- Featured Post Card - Full Width Glass Card -->
          {latestPost && (
            <a
              href={`/blog/${latestPost.slug}`}
              class="writing-featured-card block w-full bg-white/[0.03] backdrop-blur-xl border border-white/10 rounded-lg p-8 md:p-10 mb-12 transition-all duration-300 ease-out"
            >
              <div class="flex flex-col md:flex-row gap-6">
                {latestPost.coverImage && (
                  <div class="featured-post-thumbnail flex-shrink-0">
                    <img
                      src={latestPost.coverImage}
                      alt={latestPost.title}
                      class="w-full md:w-48 h-32 md:h-32 object-cover rounded-lg border border-white/10"
                      loading="lazy"
                    />
                  </div>
                )}
                <div class="flex-1">
                  <h2 class="writing-featured-post-title text-2xl md:text-3xl font-serif font-bold text-white mb-4 transition-all duration-300 ease-out">
                    {latestPost.title}
                  </h2>
                  {latestPost.excerpt && (
                    <p class="text-base text-zinc-300 mb-4 font-sans line-clamp-2 leading-relaxed">
                      {latestPost.excerpt}
                    </p>
                  )}
                  <div class="featured-post-meta">
                    <time 
                      datetime={latestPost.publishedAt.toISOString()} 
                      class="text-sm text-zinc-500 font-sans"
                    >
                      {latestPost.publishedAt.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                      })}
                    </time>
                    {featuredPostReadingTime > 0 ? (
                      <span class="flex items-center gap-2">
                        <span class="text-zinc-500/40">·</span>
                        <span class="text-sm text-zinc-500 font-sans">
                          {featuredPostReadingTime} min
                        </span>
                      </span>
                    ) : null}
                  </div>
                </div>
              </div>
            </a>
          )}

          <!-- Archive List - Simple Vertical List -->
          {olderPostsWithReadTime.length > 0 && (
            <div>
              {olderPostsWithReadTime.map(({ post, readTime }) => (
                <ArticleRow post={post} readTime={readTime} />
              ))}
            </div>
          )}
        </div>
      ) : (
        <div class="bg-white/[0.03] backdrop-blur-xl border border-white/10 rounded-lg p-12 text-center border-t-white/20">
          <p class="text-lg text-zinc-300 font-sans">
            No blog posts yet. Posts will appear here once the Blogger sync script runs.
          </p>
          <p class="mt-4 text-sm text-zinc-500 font-mono">
            Run <code class="bg-zinc-950/50 px-2 py-1 rounded border border-zinc-800">npm run sync:blog</code> to fetch posts.
          </p>
        </div>
      )}
      
      <!-- Back Navigation -->
      <footer class="mt-12 border-t border-zinc-800 pt-6">
        <BackNavigation href="/#writing" label="Back to Home" />
      </footer>
    </div>
  </main>
</BaseLayout>

<style>
  /* Glass Card Hover Effect - Matching Work Section */
  .writing-featured-card {
    transition: all 0.3s ease-out;
  }

  .writing-featured-card:hover {
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
  }

  /* Featured Post Meta */
  .featured-post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .meta-separator {
    color: rgba(161, 161, 170, 0.4);
    font-size: 0.875rem;
  }

  .meta-read-time {
    font-size: 0.875rem;
    color: #71717a;
  }

  /* Featured Post Title Hover Effect */
  .writing-featured-post-title {
    transition: color 0.2s ease, transform 0.2s ease;
  }

  .writing-featured-card:hover .writing-featured-post-title {
    color: #fff;
    transform: translateX(5px);
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
  }
</style>
