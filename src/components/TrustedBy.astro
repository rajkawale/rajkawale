---
import { trustedBy } from '../data/trustedBy';

const featuredTestimonials = trustedBy.filter((person) => person.featured);

// Function to get initials from name
function getInitials(name: string): string {
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1) {
    return parts[0].substring(0, 2).toUpperCase();
  }
  return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
}

// Function to convert name to URL-friendly slug
function toSlug(name: string): string {
  return name.toLowerCase().replace(/\s+/g, '-');
}
---

<section id="trusted-by" class="section-spacer pb-24 px-6 md:px-12 mt-24">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-16 text-center">
      <h2 class="text-4xl md:text-5xl font-serif font-bold text-slate-100 mb-4">
        Trusted By<span class="text-gray-500">.</span>
      </h2>
      <p class="text-zinc-400 text-lg font-sans">
        Perspectives from people I've built products with.
      </p>
    </div>

    <!-- Brick Layout Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
      {featuredTestimonials.map((person) => {
        // Use shortText for Rob Christie on homepage, otherwise use full text
        const displayText = person.shortText || person.text;
        
        return (
          <div
            class={`moonlight-container trusted-card bg-neutral-900/50 backdrop-blur-xl border border-white/10 rounded-xl p-6 flex flex-col gap-4 transition-all duration-300 ease-out cursor-pointer group hover:border-neutral-200 ${person.gridClass}`}
            data-trusted-card
            data-slug={toSlug(person.name)}
          >
            <!-- Header: Avatar + Name + Role -->
            <div class="flex items-start gap-3">
              <!-- Avatar -->
              <div class="profile-image-container w-10 h-10 rounded-full border-2 border-white/20 flex items-center justify-center bg-gradient-to-br from-purple-500/20 to-blue-500/20 relative overflow-hidden flex-shrink-0">
                <img
                  src={person.image}
                  alt={person.name}
                  class="profile-image w-full h-full rounded-full object-cover absolute inset-0"
                  data-person-name={person.name}
                />
                <span
                  class="profile-initials text-white font-semibold text-sm hidden"
                  data-initials={getInitials(person.name)}
                >
                  {getInitials(person.name)}
                </span>
              </div>

              <!-- Name + Role -->
              <div class="flex-1 min-w-0">
                <a
                  href={person.linkedin}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="group moonlight-text-link text-white font-serif font-bold text-sm transition-all duration-300 ease-out inline-flex items-center gap-1.5 mb-1"
                  onclick="event.stopPropagation()"
                >
                  {person.name}
                  <svg 
                    class="w-4 h-4 text-neutral-500 group-hover:text-white transition-colors flex-shrink-0" 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                  >
                    <path 
                      stroke-linecap="round" 
                      stroke-linejoin="round" 
                      stroke-width="2" 
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                    />
                  </svg>
                </a>
                <p class="text-zinc-500 text-xs font-sans leading-tight">{person.role}</p>
              </div>
            </div>

            <!-- Body: Quote Text -->
            <p class="text-neutral-300 text-sm leading-relaxed font-sans font-light line-clamp-4">
              {displayText}
            </p>
          </div>
        );
      })}
    </div>

    <!-- View All Perspectives Link - Bottom Right -->
    <div class="archive-link-container">
      <a href="/trusted-by" class="text-xs font-mono text-neutral-500 hover:text-neutral-300 transition-colors inline-flex items-center gap-1">
        View all perspectives â†’
      </a>
    </div>
  </div>
</section>

<style>
  /* Moonlight Container Hover Effect */
  .moonlight-container {
    transition: all 0.3s ease-out;
  }

  .moonlight-container:hover {
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .trusted-card:hover {
    transform: translateY(-2px);
  }

  /* Moonlight Text Link Hover Effect */
  .moonlight-text-link {
    transition: all 0.3s ease-out;
  }

  .moonlight-text-link:hover {
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
  }

  /* Line clamp utility */
  .line-clamp-4 {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Archive Link Container - Matching Think Section */
  .archive-link-container {
    margin-top: 24px;
    display: flex;
    justify-content: flex-end;
  }
</style>

<script>
  // Handle image load errors and show initials fallback
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.profile-image').forEach((img) => {
      // Function to show initials fallback
      const showInitials = (imageElement: HTMLImageElement) => {
        imageElement.style.display = 'none';
        const container = imageElement.closest('.profile-image-container');
        const initialsSpan = container?.querySelector('.profile-initials');
        if (initialsSpan) {
          initialsSpan.classList.remove('hidden');
          initialsSpan.style.display = 'flex';
        }
      };
      
      // Check if image is already loaded and failed
      if (img.complete) {
        if (img.naturalHeight === 0 || img.naturalWidth === 0) {
          showInitials(img);
        }
      } else {
        // Image is still loading, wait for load or error
        img.addEventListener('load', function() {
          // Image loaded successfully, do nothing
        });
      }
      
      // Handle error event
      img.addEventListener('error', function() {
        showInitials(this);
      });
    });

    // Handle card clicks for navigation
    document.querySelectorAll('[data-trusted-card]').forEach((card) => {
      card.addEventListener('click', (e) => {
        // Don't navigate if clicking on the LinkedIn link (it will stop propagation)
        const slug = card.getAttribute('data-slug');
        if (slug) {
          window.location.href = `/trusted-by#${slug}`;
        }
      });
    });
  });
</script>
