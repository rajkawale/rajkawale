<script>
    // PDF/Document Viewer Modal Logic
    let isModalOpen = false;
    let modalUrl = "";
    let modalTitle = "";

    function openPDFModal(url: string, title: string) {
        // Convert Google Drive view links to embed links
        let embedUrl = url;
        if (url.includes("drive.google.com")) {
            const fileId = url.match(/[-\w]{25,}/)?.[0];
            if (fileId) {
                embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            }
        }

        modalUrl = embedUrl;
        modalTitle = title;
        isModalOpen = true;
        document.body.style.overflow = "hidden";
    }

    function closePDFModal() {
        isModalOpen = false;
        modalUrl = "";
        modalTitle = "";
        document.body.style.overflow = "auto";
    }

    // Make functions globally available
    if (typeof window !== "undefined") {
        (window as any).openPDFModal = openPDFModal;
        (window as any).closePDFModal = closePDFModal;
    }

    // Close modal on Escape key
    if (typeof window !== "undefined") {
        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && isModalOpen) {
                closePDFModal();
            }
        });
    }
</script>

<!-- PDF Viewer Modal -->
<div
    id="pdf-modal"
    class="fixed inset-0 z-[9999]"
    style="display: none;"
    data-modal-open="false"
>
    <!-- Backdrop -->
    <div
        class="absolute inset-0 bg-black/80 backdrop-blur-sm"
        onclick="window.closePDFModal()"
    >
    </div>

    <!-- Modal Container -->
    <div
        class="relative z-10 flex items-center justify-center min-h-screen p-4 md:p-8"
    >
        <div
            class="relative w-full max-w-7xl bg-zinc-900 rounded-2xl shadow-2xl overflow-hidden"
            onclick="event.stopPropagation()"
        >
            <!-- Header -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-white/10 bg-zinc-900/95"
            >
                <h3 id="modal-title" class="text-xl font-serif text-slate-100">
                    Document Viewer
                </h3>
                <button
                    onclick="window.closePDFModal()"
                    class="p-2 text-zinc-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                    aria-label="Close modal"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- PDF/Document Viewer -->
            <div class="relative w-full" style="height: 80vh;">
                <iframe
                    id="pdf-iframe"
                    src=""
                    class="w-full h-full border-0"
                    allow="autoplay"></iframe>
            </div>

            <!-- Footer with Actions -->
            <div
                class="flex items-center justify-between px-6 py-4 border-t border-white/10 bg-zinc-900/95"
            >
                <p class="text-sm text-zinc-400">Use Esc key to close</p>
                <a
                    id="open-in-new-tab"
                    href=""
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-white/10 hover:bg-white/20 rounded-lg transition-colors"
                >
                    Open in new tab
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        ></path>
                    </svg>
                </a>
            </div>
        </div>
    </div>
</div>

<script is:inline>
    // Client-side modal control with debugging
    window.openPDFModal = function (url, title) {
        console.log("[PDFModal] openPDFModal called:", { url, title });

        const modal = document.getElementById("pdf-modal");
        const iframe = document.getElementById("pdf-iframe");
        const modalTitle = document.getElementById("modal-title");
        const newTabLink = document.getElementById("open-in-new-tab");

        console.log("[PDFModal] Elements found:", {
            modal: !!modal,
            iframe: !!iframe,
            modalTitle: !!modalTitle,
            newTabLink: !!newTabLink,
        });

        if (!modal) {
            console.error(
                "[PDFModal] Modal element #pdf-modal not found in DOM!",
            );
            return;
        }

        // Convert Google Drive view links to embed links
        let embedUrl = url;
        if (url.includes("drive.google.com")) {
            const fileId = url.match(/[-\w]{25,}/)?.[0];
            console.log("[PDFModal] Drive file ID:", fileId);
            if (fileId) {
                embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            }
        }

        console.log("[PDFModal] Setting iframe src to:", embedUrl);

        iframe.src = embedUrl;
        modalTitle.textContent = title || "Document Viewer";
        newTabLink.href = url;

        console.log("[PDFModal] Setting display to block");
        modal.style.display = "block";
        modal.setAttribute("data-modal-open", "true");
        document.body.style.overflow = "hidden";

        console.log(
            "[PDFModal] Modal display after setting:",
            modal.style.display,
        );
        console.log(
            "[PDFModal] Modal data-modal-open:",
            modal.getAttribute("data-modal-open"),
        );
    };

    window.closePDFModal = function () {
        console.log("[PDFModal] closePDFModal called");
        const modal = document.getElementById("pdf-modal");
        const iframe = document.getElementById("pdf-iframe");

        if (modal) {
            modal.style.display = "none";
            modal.setAttribute("data-modal-open", "false");
            iframe.src = "";
            document.body.style.overflow = "auto";
        }
    };

    // Close on Escape key
    document.addEventListener("keydown", function (e) {
        const modal = document.getElementById("pdf-modal");
        if (
            e.key === "Escape" &&
            modal?.getAttribute("data-modal-open") === "true"
        ) {
            window.closePDFModal();
        }
    });
</script>

<style>
    #pdf-modal[data-modal-open="true"] {
        display: block !important;
    }
</style>
