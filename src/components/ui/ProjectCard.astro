---
import type { CollectionEntry } from "astro:content";
import { ExternalLink, Eye } from "lucide-react";

interface Props {
  project: CollectionEntry<"work">;
  size?: "large" | "medium" | "small";
  hideSecondaryLink?: boolean;
}

const { project: workItem, size = "medium", hideSecondaryLink = false } = Astro.props;
const project = workItem.data;
const slug = workItem.slug;

// Determine main link URL and label based on pdfUrl
const mainLinkUrl = project.pdfUrl || `/work/${slug}`;
const hasPdfUrl = !!project.pdfUrl;

// For professional work cards, always use internal link and "View Case Study" text
const professionalWorkLinkUrl = hideSecondaryLink ? `/work/${slug}` : mainLinkUrl;
const professionalWorkLinkText = hideSecondaryLink ? 'View Case Study' : (hasPdfUrl ? 'View Case Study' : 'Read Case');


---

<div
  class={`project-card group relative rounded-lg p-8 flex flex-col justify-between overflow-hidden cursor-pointer transition-all duration-300 ease-out ${
    size === 'large' && slug === 'raitalk'
      ? 'neural-wave-card'
      : 'glass-card'
  }`}
  data-project-slug={slug}
>
  <!-- Neural Wave Animation for RaiTalk Card -->
  {size === 'large' && slug === 'raitalk' && (
    <div class="neural-wave-container absolute inset-0 pointer-events-none z-0">
      <svg class="neural-wave-svg" viewBox="0 0 1200 300" preserveAspectRatio="xMidYMax slice">
        <defs>
          <linearGradient id="waveGradient1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:rgba(255,255,255,0.3);stop-opacity:0" />
            <stop offset="50%" style="stop-color:rgba(255,255,255,0.3);stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255,255,255,0.3);stop-opacity:0" />
          </linearGradient>
          <linearGradient id="waveGradient2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:rgba(255,255,255,0.25);stop-opacity:0" />
            <stop offset="50%" style="stop-color:rgba(255,255,255,0.25);stop-opacity:1" />
            <stop offset="100%" style="stop-color:rgba(255,255,255,0.25);stop-opacity:0" />
          </linearGradient>
        </defs>
        <!-- Sine wave paths - multiple layers for depth -->
        <path
          class="neural-wave neural-wave-1"
          d="M 0,150 Q 150,100 300,150 T 600,150 T 900,150 T 1200,150"
          fill="none"
          stroke="url(#waveGradient1)"
          stroke-width="1"
        />
        <path
          class="neural-wave neural-wave-2"
          d="M 0,170 Q 150,120 300,170 T 600,170 T 900,170 T 1200,170"
          fill="none"
          stroke="url(#waveGradient2)"
          stroke-width="0.8"
        />
        <path
          class="neural-wave neural-wave-3"
          d="M 0,190 Q 150,140 300,190 T 600,190 T 900,190 T 1200,190"
          fill="none"
          stroke="url(#waveGradient2)"
          stroke-width="0.6"
        />
        <path
          class="neural-wave neural-wave-4"
          d="M 0,130 Q 150,80 300,130 T 600,130 T 900,130 T 1200,130"
          fill="none"
          stroke="url(#waveGradient1)"
          stroke-width="0.5"
        />
      </svg>
    </div>
  )}
  <div class="flex-1 flex flex-col relative z-10">
    <!-- Header -->
    <div class="mb-4">
      <h3 class="text-2xl font-serif font-normal text-slate-100 group-hover:text-white transition-colors mb-3">
        {project.title}
      </h3>
      <p class="text-sm text-zinc-400 leading-relaxed font-sans">
        {project.description}
      </p>
    </div>
  </div>

  <!-- Footer -->
  <div class="flex items-center justify-end mt-auto pt-4 border-t border-zinc-800/50 relative z-10">
    <div class="flex items-center gap-6 flex-wrap">
      {/* Main CTA Link - PDF or Internal (Primary) */}
      <a
        href={professionalWorkLinkUrl}
        class={`text-white font-semibold flex items-center gap-2 z-10 relative ${size === 'large' ? 'text-lg' : ''}`}
      >
        <span>{professionalWorkLinkText}</span>
        <span>→</span>
      </a>
      {/* Secondary Links - Hidden for professional work */}
      {!hideSecondaryLink && (
        <>
          {project.actionType === 'drive' && (
            <button
              data-drive-file-id={project.actionUrl?.match(/file\/d\/(.*?)\//)?.[1]}
              data-drive-title={project.title}
              class="project-drive-viewer-button text-zinc-400 hover:text-white text-sm font-normal flex items-center gap-1 z-10 relative cursor-pointer transition-colors"
            >
              <span>View Pitch Deck</span>
              <span>↗</span>
            </button>
          )}
          {/* Legacy actionUrl support (for non-PDF external links) */}
          {project.actionUrl && project.actionType !== 'drive' && !project.pdfUrl && (
            <a
              href={project.actionUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-zinc-400 hover:text-white text-sm font-normal flex items-center gap-1 z-10 relative transition-colors"
            >
              <span>{project.actionLabel || "Visit Website"}</span>
              <span>↗</span>
            </a>
          )}
          {project.actionType === 'repo' && (
            <a
              href={project.actionUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-zinc-400 hover:text-white text-sm font-normal flex items-center gap-1 z-10 relative transition-colors"
            >
              <span>Code</span>
              <span>↗</span>
            </a>
          )}
        </>
      )}
    </div>
  </div>
</div>

<style>
  /* Glassmorphism Style - Matching Recent Writing */
  .glass-card,
  .neural-wave-card {
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Neural Wave Card - Special styling for RaiTalk */
  .neural-wave-card {
    position: relative;
  }

  /* Neural Wave Animation Container */
  .neural-wave-container {
    overflow: hidden;
    bottom: 0;
    height: 50%;
  }

  .neural-wave-svg {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.3;
  }

  /* Neural Wave Animation - Slow horizontal flow (like audio visualizer/brain frequency) */
  @keyframes waveFlow {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  .neural-wave {
    animation: waveFlow linear infinite;
  }

  .neural-wave-1 {
    animation-duration: 15s;
    animation-delay: 0s;
  }

  .neural-wave-2 {
    animation-duration: 18s;
    animation-delay: 3s;
  }

  .neural-wave-3 {
    animation-duration: 20s;
    animation-delay: 6s;
  }

  .neural-wave-4 {
    animation-duration: 16s;
    animation-delay: 1.5s;
  }

  /* White Glow Hover Effect for Cards - Border brightness increases */
  .project-card {
    transition: all 0.3s ease-out;
  }

  .project-card:hover {
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
  }

  /* Glassmorphism Buttons */
  .glass-button {
    transition: all 0.3s ease-out;
  }

  .glass-button:hover {
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
  }

  /* Text Links Hover */
  .project-card a:not(.glass-button) {
    color: #888;
    transition: all 0.3s ease-out;
  }

  .project-card a:not(.glass-button):hover {
    color: #fff;
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
  }
</style>

<script define:vars={{ projectSlug: slug }}>
  // Track Clarity events
  function trackEvent(eventName) {
    if (typeof window !== 'undefined' && window.clarity) {
      window.clarity('event', eventName);
    }
  }

  // Make entire card clickable except for demo/repo links
  document.querySelectorAll(`.project-card[data-project-slug="${projectSlug}"]`).forEach((card) => {
    const slug = card.dataset.projectSlug;
    const slugFormatted = slug.charAt(0).toUpperCase() + slug.slice(1).replace(/-/g, '_');
    
    // Track project card hover
    let hoverTracked = false;
    card.addEventListener('mouseenter', () => {
      if (!hoverTracked) {
        trackEvent(`Project_Card_Hover_${slugFormatted}`);
        hoverTracked = true;
      }
    });
    
    // Track project-specific button clicks
    const demoButton = card.querySelector('a.glass-button[target="_blank"]');
    const codeButton = card.querySelector('a.glass-button[href*="github"], a.glass-button[href*="git"]');
    
    if (demoButton) {
      demoButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (slug === 'raitalk') {
          trackEvent('Click_RaiTalk_Demo');
        } else if (slug === 'trinka') {
          trackEvent('Click_Trinka_Proto');
        } else if (slug === 'madhav-farm') {
          trackEvent('Click_MadhavFarm_Case');
        } else {
          trackEvent(`Project_Demo_Click_${slugFormatted}`);
        }
      });
    }
    
    if (codeButton) {
      codeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        trackEvent(`Project_Code_Click_${slugFormatted}`);
      });
    }
    
    // Handle Drive Viewer button clicks
    const driveButton = card.querySelector('.project-drive-viewer-button');
    if (driveButton) {
      driveButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const fileId = driveButton.getAttribute('data-drive-file-id');
        const title = driveButton.getAttribute('data-drive-title') || 'Document Viewer';
        
        if (fileId && typeof window !== 'undefined' && window.openDriveViewer) {
          window.openDriveViewer(fileId, title);
          trackEvent('Click_MadhavFarm_PitchDeck');
        }
      });
    }
    
    card.addEventListener('click', (e) => {
      // Don't navigate if clicking on external links, PDF links, or drive viewer button
      if (e.target.closest('a[target="_blank"]') || e.target.closest('.project-drive-viewer-button') || e.target.closest('.pdf-link')) {
        return;
      }
      // Track card click
      trackEvent(`Project_Card_Click_${slugFormatted}`);
      // Only open modal if no PDF URL (internal pages)
      const pdfLink = card.querySelector('.pdf-link');
      if (!pdfLink && slug) {
        // Navigate to work page for non-PDF items
        window.location.href = `/work/${slug}`;
      }
    });
    
    function openProjectDetailModal(slug) {
      // Fetch project data and content
      fetch(`/api/project/${slug}`)
        .then(res => res.json())
        .then(data => {
          if (data.project && typeof window !== 'undefined' && window.openProjectDetailModal) {
            window.openProjectDetailModal(data.project, data.content);
          }
        })
        .catch(err => {
          console.error('Error loading project:', err);
          // Fallback to navigation
          window.location.href = `/projects/${slug}`;
        });
    }
  });
</script>

